import React, { useState, useEffect } from 'react';
import { 
  Database, Filter, Transform, Code, Play, Download, 
  RefreshCw, Settings, Eye, Table, BarChart3, Zap,
  Plus, Minus, Edit3, Copy, Trash2, ChevronDown,
  Search, SortAsc, SortDesc, Calendar, Hash,
  Type, ToggleLeft, ToggleRight, AlertCircle
} from 'lucide-react';

const PowerQueryPage = () => {
  const [uploadResult, setUploadResult] = useState(null);
  const [dataPreview, setDataPreview] = useState([]);
  const [transformations, setTransformations] = useState([]);
  const [selectedColumns, setSelectedColumns] = useState([]);
  const [activeTransform, setActiveTransform] = useState(null);
  const [queryCode, setQueryCode] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);

  useEffect(() => {
    const stored = localStorage.getItem('uploadResult');
    if (stored) {
      const result = JSON.parse(stored);
      setUploadResult(result);
      generateSampleData(result);
    }
  }, []);

  const generateSampleData = (metadata) => {
    if (!metadata) return;
    
    const { column_names, inferred_column_types, number_of_rows } = metadata;
    const sampleSize = Math.min(100, number_of_rows || 50);
    const sample = [];
    
    for (let i = 0; i < sampleSize; i++) {
      const row = {};
      column_names?.forEach(column => {
        const columnType = inferred_column_types?.[column];
        
        if (columnType === 'numeric') {
          if (column.toLowerCase().includes('age')) {
            row[column] = Math.floor(Math.random() * 60) + 18;
          } else if (column.toLowerCase().includes('salary') || column.toLowerCase().includes('income')) {
            row[column] = Math.floor(Math.random() * 80000) + 30000;
          } else if (column.toLowerCase().includes('price')) {
            row[column] = Math.floor(Math.random() * 1000) + 10;
          } else {
            row[column] = Math.round(Math.random() * 1000) / 10;
          }
        } else {
          if (column.toLowerCase().includes('name')) {
            const names = ['John Smith', 'Jane Doe', 'Mike Johnson', 'Sarah Wilson', 'David Brown'];
            row[column] = names[Math.floor(Math.random() * names.length)];
          } else if (column.toLowerCase().includes('category')) {
            const categories = ['Premium', 'Standard', 'Basic', 'Enterprise'];
            row[column] = categories[Math.floor(Math.random() * categories.length)];
          } else if (column.toLowerCase().includes('status')) {
            const statuses = ['Active', 'Inactive', 'Pending', 'Completed'];
            row[column] = statuses[Math.floor(Math.random() * statuses.length)];
          } else if (column.toLowerCase().includes('date')) {
            const date = new Date(2023, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
            row[column] = date.toISOString().split('T')[0];
          } else {
            const values = ['Option A', 'Option B', 'Option C', 'Option D', 'Option E'];
            row[column] = values[Math.floor(Math.random() * values.length)];
          }
        }
      });
      sample.push(row);
    }
    
    setDataPreview(sample);
    generateInitialQuery(column_names);
  };\n\n  const generateInitialQuery = (columns) => {
    const query = `let
    Source = Excel.Workbook(File.Contents("${uploadResult?.filename || 'data.xlsx'}"), null, true),
    Sheet1_Sheet = Source{[Item="Sheet1",Kind="Sheet"]}[Data],
    #"Promoted Headers" = Table.PromoteHeaders(Sheet1_Sheet, [PromoteAllScalars=true]),
    #"Changed Type" = Table.TransformColumnTypes(#"Promoted Headers",{${columns?.map(col => `{"${col}", type text}`).join(', ') || ''}})
in
    #"Changed Type"`;
    
    setQueryCode(query);
  };\n\n  const addTransformation = (type, config) => {\n    const newTransform = {\n      id: Date.now(),\n      type,\n      config,\n      applied: false\n    };\n    \n    setTransformations(prev => [...prev, newTransform]);\n    updateQueryCode([...transformations, newTransform]);\n  };\n\n  const removeTransformation = (id) => {\n    const updated = transformations.filter(t => t.id !== id);\n    setTransformations(updated);\n    updateQueryCode(updated);\n  };\n\n  const updateQueryCode = (transforms) => {\n    let query = `let\n    Source = Excel.Workbook(File.Contents(\"${uploadResult?.filename || 'data.xlsx'}\"), null, true),\n    Sheet1_Sheet = Source{[Item=\"Sheet1\",Kind=\"Sheet\"]}[Data],\n    #\"Promoted Headers\" = Table.PromoteHeaders(Sheet1_Sheet, [PromoteAllScalars=true])`;\n    \n    transforms.forEach((transform, index) => {\n      const stepName = `#\"${transform.type} ${index + 1}\"`;\n      switch (transform.type) {\n        case 'Filter Rows':\n          query += `,\n    ${stepName} = Table.SelectRows(#\"Promoted Headers\", each [${transform.config.column}] ${transform.config.operator} \"${transform.config.value}\")`;\n          break;\n        case 'Remove Columns':\n          query += `,\n    ${stepName} = Table.RemoveColumns(#\"Promoted Headers\",{\"${transform.config.columns.join('\", \"')}\"})`;\n          break;\n        case 'Rename Column':\n          query += `,\n    ${stepName} = Table.RenameColumns(#\"Promoted Headers\",{{\"${transform.config.oldName}\", \"${transform.config.newName}\"}})`;\n          break;\n        case 'Change Type':\n          query += `,\n    ${stepName} = Table.TransformColumnTypes(#\"Promoted Headers\",{{\"${transform.config.column}\", ${transform.config.dataType}}})`;\n          break;\n        case 'Add Column':\n          query += `,\n    ${stepName} = Table.AddColumn(#\"Promoted Headers\", \"${transform.config.name}\", each ${transform.config.formula})`;\n          break;\n        default:\n          break;\n      }\n    });\n    \n    query += `\nin\n    ${transforms.length > 0 ? `#\"${transforms[transforms.length - 1].type} ${transforms.length}\"` : '#\"Promoted Headers\"'}`;\n    \n    setQueryCode(query);\n  };\n\n  const applyTransformations = async () => {\n    setIsProcessing(true);\n    \n    // Simulate processing time\n    await new Promise(resolve => setTimeout(resolve, 2000));\n    \n    // Apply transformations to preview data\n    let processedData = [...dataPreview];\n    \n    transformations.forEach(transform => {\n      switch (transform.type) {\n        case 'Filter Rows':\n          processedData = processedData.filter(row => {\n            const value = row[transform.config.column];\n            switch (transform.config.operator) {\n              case '=':\n                return value == transform.config.value;\n              case '!=':\n                return value != transform.config.value;\n              case '>':\n                return parseFloat(value) > parseFloat(transform.config.value);\n              case '<':\n                return parseFloat(value) < parseFloat(transform.config.value);\n              default:\n                return true;\n            }\n          });\n          break;\n        case 'Remove Columns':\n          processedData = processedData.map(row => {\n            const newRow = { ...row };\n            transform.config.columns.forEach(col => delete newRow[col]);\n            return newRow;\n          });\n          break;\n        case 'Rename Column':\n          processedData = processedData.map(row => {\n            const newRow = { ...row };\n            if (newRow[transform.config.oldName] !== undefined) {\n              newRow[transform.config.newName] = newRow[transform.config.oldName];\n              delete newRow[transform.config.oldName];\n            }\n            return newRow;\n          });\n          break;\n        default:\n          break;\n      }\n    });\n    \n    setDataPreview(processedData);\n    setIsProcessing(false);\n  };\n\n  const TransformationPanel = () => {\n    const [showPanel, setShowPanel] = useState(false);\n    const [transformType, setTransformType] = useState('');\n    const [config, setConfig] = useState({});\n\n    const transformOptions = [\n      { value: 'Filter Rows', icon: Filter, description: 'Filter rows based on conditions' },\n      { value: 'Remove Columns', icon: Minus, description: 'Remove selected columns' },\n      { value: 'Rename Column', icon: Edit3, description: 'Rename a column' },\n      { value: 'Change Type', icon: Type, description: 'Change column data type' },\n      { value: 'Add Column', icon: Plus, description: 'Add calculated column' },\n      { value: 'Sort', icon: SortAsc, description: 'Sort by column' },\n      { value: 'Group By', icon: BarChart3, description: 'Group and aggregate data' }\n    ];\n\n    const handleAddTransform = () => {\n      if (transformType && Object.keys(config).length > 0) {\n        addTransformation(transformType, config);\n        setTransformType('');\n        setConfig({});\n        setShowPanel(false);\n      }\n    };\n\n    return (\n      <div className=\"transformation-panel\">\n        <button \n          className=\"btn btn-primary\"\n          onClick={() => setShowPanel(!showPanel)}\n        >\n          <Plus size={16} />\n          Add Transformation\n        </button>\n        \n        {showPanel && (\n          <div className=\"transform-config\">\n            <div className=\"transform-selector\">\n              <label>Transformation Type:</label>\n              <select \n                value={transformType}\n                onChange={(e) => setTransformType(e.target.value)}\n              >\n                <option value=\"\">Select transformation...</option>\n                {transformOptions.map(option => (\n                  <option key={option.value} value={option.value}>\n                    {option.value}\n                  </option>\n                ))}\n              </select>\n            </div>\n            \n            {transformType === 'Filter Rows' && (\n              <div className=\"config-inputs\">\n                <select \n                  value={config.column || ''}\n                  onChange={(e) => setConfig({...config, column: e.target.value})}\n                >\n                  <option value=\"\">Select column...</option>\n                  {uploadResult?.column_names?.map(col => (\n                    <option key={col} value={col}>{col}</option>\n                  ))}\n                </select>\n                <select \n                  value={config.operator || ''}\n                  onChange={(e) => setConfig({...config, operator: e.target.value})}\n                >\n                  <option value=\"\">Operator...</option>\n                  <option value=\"=\">Equals</option>\n                  <option value=\"!=\">Not Equals</option>\n                  <option value=\">\">Greater Than</option>\n                  <option value=\"<\">Less Than</option>\n                </select>\n                <input \n                  type=\"text\"\n                  placeholder=\"Value\"\n                  value={config.value || ''}\n                  onChange={(e) => setConfig({...config, value: e.target.value})}\n                />\n              </div>\n            )}\n            \n            {transformType === 'Remove Columns' && (\n              <div className=\"config-inputs\">\n                <div className=\"column-selector\">\n                  <label>Select columns to remove:</label>\n                  {uploadResult?.column_names?.map(col => (\n                    <label key={col} className=\"checkbox-option\">\n                      <input \n                        type=\"checkbox\"\n                        checked={config.columns?.includes(col) || false}\n                        onChange={(e) => {\n                          const columns = config.columns || [];\n                          if (e.target.checked) {\n                            setConfig({...config, columns: [...columns, col]});\n                          } else {\n                            setConfig({...config, columns: columns.filter(c => c !== col)});\n                          }\n                        }}\n                      />\n                      <span>{col}</span>\n                    </label>\n                  ))}\n                </div>\n              </div>\n            )}\n            \n            {transformType === 'Rename Column' && (\n              <div className=\"config-inputs\">\n                <select \n                  value={config.oldName || ''}\n                  onChange={(e) => setConfig({...config, oldName: e.target.value})}\n                >\n                  <option value=\"\">Select column...</option>\n                  {uploadResult?.column_names?.map(col => (\n                    <option key={col} value={col}>{col}</option>\n                  ))}\n                </select>\n                <input \n                  type=\"text\"\n                  placeholder=\"New name\"\n                  value={config.newName || ''}\n                  onChange={(e) => setConfig({...config, newName: e.target.value})}\n                />\n              </div>\n            )}\n            \n            <div className=\"config-actions\">\n              <button className=\"btn btn-success\" onClick={handleAddTransform}>\n                Add\n              </button>\n              <button className=\"btn btn-secondary\" onClick={() => setShowPanel(false)}>\n                Cancel\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  if (!uploadResult) {\n    return (\n      <div className=\"power-query-page\">\n        <div className=\"page-header\">\n          <h1><Transform size={32} />Power Query Editor</h1>\n          <p>Transform and shape your data with advanced query capabilities</p>\n        </div>\n        \n        <div className=\"empty-state\">\n          <Database size={64} color=\"#6B7280\" />\n          <h3>No Data Source Connected</h3>\n          <p>Upload a dataset to start building powerful data transformations</p>\n          <button \n            onClick={() => window.location.href = '/'}\n            className=\"btn btn-primary\"\n          >\n            <Database size={16} />\n            Connect Data Source\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"power-query-page\">\n      <div className=\"page-header\">\n        <h1><Transform size={32} />Power Query Editor</h1>\n        <p>Transform and shape your data with advanced query capabilities</p>\n      </div>\n\n      <div className=\"query-workspace\">\n        {/* Left Panel - Transformations */}\n        <div className=\"transformations-panel\">\n          <div className=\"panel-header\">\n            <h3><Settings size={20} />Applied Steps</h3>\n            <TransformationPanel />\n          </div>\n          \n          <div className=\"steps-list\">\n            <div className=\"step-item source\">\n              <Database size={16} />\n              <span>Source</span>\n            </div>\n            <div className=\"step-item\">\n              <Table size={16} />\n              <span>Promoted Headers</span>\n            </div>\n            \n            {transformations.map((transform, index) => (\n              <div key={transform.id} className=\"step-item\">\n                <Transform size={16} />\n                <span>{transform.type} {index + 1}</span>\n                <button \n                  className=\"remove-step\"\n                  onClick={() => removeTransformation(transform.id)}\n                >\n                  <Trash2 size={14} />\n                </button>\n              </div>\n            ))}\n          </div>\n          \n          <div className=\"panel-actions\">\n            <button \n              className=\"btn btn-primary\"\n              onClick={applyTransformations}\n              disabled={isProcessing}\n            >\n              {isProcessing ? (\n                <>\n                  <RefreshCw size={16} className=\"spinning\" />\n                  Processing...\n                </>\n              ) : (\n                <>\n                  <Play size={16} />\n                  Apply Changes\n                </>\n              )}\n            </button>\n            <button className=\"btn btn-secondary\">\n              <Download size={16} />\n              Export Query\n            </button>\n          </div>\n        </div>\n\n        {/* Center Panel - Data Preview */}\n        <div className=\"data-preview-panel\">\n          <div className=\"panel-header\">\n            <h3><Eye size={20} />Data Preview</h3>\n            <div className=\"preview-stats\">\n              <span>{dataPreview.length} rows</span>\n              <span>{Object.keys(dataPreview[0] || {}).length} columns</span>\n            </div>\n          </div>\n          \n          <div className=\"data-table-container\">\n            {dataPreview.length > 0 && (\n              <table className=\"data-table\">\n                <thead>\n                  <tr>\n                    {Object.keys(dataPreview[0]).map(column => (\n                      <th key={column}>\n                        <div className=\"column-header\">\n                          <span>{column}</span>\n                          <div className=\"column-actions\">\n                            <button title=\"Sort Ascending\">\n                              <SortAsc size={14} />\n                            </button>\n                            <button title=\"Filter\">\n                              <Filter size={14} />\n                            </button>\n                            <button title=\"More Options\">\n                              <ChevronDown size={14} />\n                            </button>\n                          </div>\n                        </div>\n                      </th>\n                    ))}\n                  </tr>\n                </thead>\n                <tbody>\n                  {dataPreview.slice(0, 50).map((row, index) => (\n                    <tr key={index}>\n                      {Object.values(row).map((value, colIndex) => (\n                        <td key={colIndex}>\n                          {typeof value === 'number' ? value.toLocaleString() : String(value)}\n                        </td>\n                      ))}\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            )}\n          </div>\n        </div>\n\n        {/* Right Panel - Query Code */}\n        <div className=\"query-code-panel\">\n          <div className=\"panel-header\">\n            <h3><Code size={20} />M Query</h3>\n            <button className=\"btn btn-secondary btn-sm\">\n              <Copy size={14} />\n              Copy\n            </button>\n          </div>\n          \n          <div className=\"code-editor\">\n            <pre className=\"query-code\">\n              <code>{queryCode}</code>\n            </pre>\n          </div>\n          \n          <div className=\"query-info\">\n            <div className=\"info-item\">\n              <AlertCircle size={16} />\n              <span>Query is valid and ready to execute</span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default PowerQueryPage;